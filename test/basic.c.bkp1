typedef unsigned long ssize_t;
typedef unsigned long size_t;

ssize_t write(int fd, const void *buf, size_t count);

int
main(int argc, const char* argv[])
{
    unsigned long code = 0x2000004; // syscall "write"
    unsigned long stdout = 1;
    unsigned long ret = 0;

    char * str = "Hello World\n";
    unsigned long len = 12;

    char * str2 = "Hello UCLA\n";
    unsigned long len2 = 11;

    //__asm__("vmcall;\n");
    ret = write(stdout, str, len);

    /*
    __asm__(
            "movq %1, %%rax;\n"
            "movq %2, %%rdi;\n"
            "movq %3, %%rsi;\n"
            "movq %4, %%rdx;\n"
            "syscall;\n"
            "movq %%rax, %0;\n"
            : "=g"(ret)
            : "g"(code), "g"(stdout), "g"(str2), "g"(len2)
            : ); // assign from generic registers to syscall registers
    */

    return ret; // echo $?
}

ssize_t write(int fd, const void *buf, size_t count)
{
    long code = 0x2000004;
    unsigned long ret = 0;

    __asm__(/*
            "mov $0xcafe, %%rax;\n"
            "vmcall;\n"
            */
            "movq %1, %%rax;\n"
            "movq %2, %%rdi;\n"
            "movq %3, %%rsi;\n"
            "movq %4, %%rdx;\n"
            "syscall;\n"
            "movq %%rax, %0;\n"
            : "=g"(ret)
            : "g"(code), "g"(fd), "g"(buf), "g"(count)
            : );

    return ret;
}
